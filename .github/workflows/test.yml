name: Test

on: [push, pull_request]

env:
  LLVM_CONFIG: /usr/bin/llvm-config-14
  OTHER_PACKAGES: swig libpcsclite-dev llvm-14 libllvm14 llvm-14-dev gcc gcc-arm-none-eabi binutils-arm-none-eabi libnewlib-arm-none-eabi

jobs:
  test:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
    env:
      PYTHON: ${{ matrix.python-version }}
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            pip-${{ runner.os }}-${{ matrix.python-version }}-
            pip-${{ runner.os }}-
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y $OTHER_PACKAGES
      - name: Build libtommath
        run: |
          cd ext && make host stm32f3 && cd ..
      - name: Install dependencies
        run: |
          pip install -U pip setuptools wheel
      - name: Install pyecsca
        run: |
          git clone https://github.com/J08nY/pyecsca pyecsca-upstream && cd pyecsca-upstream && git submodule update --init && pip install -e ".[chipwhisperer, test, dev]" && cd ..
      - name: Install pyecsca-codegen
        run: |
          pip install -e ".[test, dev]"
      - name: Build test config
        run: |
          builder build --platform HOST --red BARRETT --no-remove -v shortw projective add-1998-cmo dbl-1998-cmo "sliding(width=3,recoding_direction=ProcessingDirection.RTL)" .
          echo -e "c7010fffffffdffffffffffffffffffffffff6e10fffffffe0000000075a30d1b9038a1156801016110fffffffdfffffffffffffffffffffffc6210e87579c11079f43dd824993c2cee5ed3e7247810161ff7528b899b2d0c28607ca52c5b867910cf5ac8395bafeb13c02da292dded7a83e9036e0101\ng\nx\n" | ./pyecsca-codegen-HOST.elf
      - name: Test
        run: |
          make test
      - name: Test (C)
        run: |
          cd test && make test_bn && ./test_bn && cd ..
      - name: Code coverage
        uses: codecov/codecov-action@v3
        if: ${{ matrix.python-version == 3.9 }}
